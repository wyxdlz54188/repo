name: Deploy Sileo Repository

on:
  push:
    branches: ["master"]
    paths:
      - 'debs/*.deb'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Setup repository tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev dpkg-sig
          
      - name: Clean previous package indexes
        run: |
          rm -f Packages Packages.bz2 Packages.gz Packages.xz
          rm -f Release Release.gpg
          
      - name: Generate Packages files in repository
        run: |
          # 在当前仓库目录生成 Packages 文件
          echo "生成 Packages 文件..."
          dpkg-scanpackages --multiversion debs > Packages
          
          # 检查是否成功生成
          if [ ! -s Packages ]; then
            echo "错误: Packages 文件为空或未生成"
            exit 1
          fi
          
          echo "Packages 文件内容预览:"
          head -10 Packages
          
      - name: Create compressed package indexes
        run: |
          # 在仓库目录创建压缩版本
          echo "创建压缩版本..."
          gzip -9c < Packages > Packages.gz
          bzip2 -9c < Packages > Packages.bz2
          xz -9c < Packages > Packages.xz
          
          echo "生成的文件:"
          ls -la Packages*
          
      - name: Create Release file
        run: |
          # 生成 Release 文件
          cat > Release << EOF
          Origin: Your Sileo Repository
          Label: Your Sileo Repository
          Suite: stable
          Version: 1.0
          Codename: ios
          Architectures: iphoneos-arm iphoneos-arm64
          Components: main
          Description: Your custom Sileo repository
          MD5Sum:
            $(md5sum Packages | cut -d' ' -f1) $(stat -c%s Packages) Packages
            $(md5sum Packages.gz | cut -d' ' -f1) $(stat -c%s Packages.gz) Packages.gz
            $(md5sum Packages.bz2 | cut -d' ' -f1) $(stat -c%s Packages.bz2) Packages.bz2
            $(md5sum Packages.xz | cut -d' ' -f1) $(stat -c%s Packages.xz) Packages.xz
          SHA256:
            $(sha256sum Packages | cut -d' ' -f1) $(stat -c%s Packages) Packages
            $(sha256sum Packages.gz | cut -d' ' -f1) $(stat -c%s Packages.gz) Packages.gz
            $(sha256sum Packages.bz2 | cut -d' ' -f1) $(stat -c%s Packages.bz2) Packages.bz2
            $(sha256sum Packages.xz | cut -d' ' -f1) $(stat -c%s Packages.xz) Packages.xz
          EOF
          
          echo "Release 文件内容:"
          cat Release
          
      - name: Commit package indexes to repository
        run: |
          # 设置 git 配置
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"
          
          # 添加生成的文件
          git add Packages Packages.gz Packages.bz2 Packages.xz Release
          
          # 检查是否有更改并提交
          if ! git diff --staged --quiet; then
            git commit -m "Auto-update: Regenerate package indexes"
            git push
            echo "✅ 成功提交 package 索引到仓库"
          else
            echo "⚠️ 没有检测到 package 索引的更改"
          fi
          
      - name: Setup Pages
        if: always()
        uses: actions/configure-pages@v5
        
      - name: Build with Jekyll
        if: always()
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site
          
      - name: Upload artifact
        if: always()
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-and-deploy
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
